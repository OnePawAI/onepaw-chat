<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OnePaw AI Chat (Always Ask Name)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eef2f3; }
    #welcomeScreen, #chat { max-width: 600px; margin: auto; }
    #chat { display: none; }
    #messages { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; background: #fff; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    #inputArea { display: flex; }
    #userInput { flex: 1; padding: 10px; }
    #sendBtn { padding: 10px; }
    .message { margin: 5px 0; padding: 8px 12px; border-radius: 15px; display: inline-block; max-width: 80%; }
    .user { text-align: right; color: blue; background: #d9f7ff; align-self: flex-end; }
    .bot { text-align: left; color: green; background: #e8ffe8; align-self: flex-start; }

    @media (max-width: 600px) {
      body { padding: 10px; }
      #messages { height: 300px; }
      #inputArea { flex-direction: column; }
      #userInput, #sendBtn { width: 100%; margin-bottom: 5px; }
    }
  </style>
</head>
<body>

<div id="welcomeScreen">
  <h2>Welcome to OnePaw AI Assistant! ðŸ‘‹</h2>
  <p>Please enter your preferred name to start chatting:</p>
  <input id="nameInput" type="text" placeholder="Your Name" />
  <br><br>
  <button id="startChatBtn">Start Chat</button>
</div>

<div id="chat">
  <h2>Chat with OnePaw AI Assistant</h2>
  <div id="messages"></div>
  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Type your message here..." aria-label="Message input" />
    <button id="sendBtn" aria-label="Send message">Send</button>
  </div>
</div>

<script>
let webhookUrl = null;

fetch('http://localhost:3000/get-webhook-url')
  .then(response => response.json())
  .then(config => {
    webhookUrl = config.webhookUrl;
    console.log("Webhook URL loaded:", webhookUrl);
  })
  .catch(error => {
    console.error("Failed to load webhook URL:", error);
    alert("Failed to connect to the server. Please try again later.");
  });

let preferredName = null;

// Always show welcome screen on load
document.getElementById('welcomeScreen').style.display = 'block';
document.getElementById('chat').style.display = 'none';

document.getElementById('startChatBtn').addEventListener('click', () => {
  localStorage.removeItem('chatHistory'); // Clear previous chat history from localStorage
  document.getElementById('messages').innerHTML = ''; // Clear chat messages from the chat window

  const nameInput = document.getElementById('nameInput').value.trim();
  if (!nameInput || nameInput.length > 50) {
    return alert("Please enter a valid name (max 50 characters).");
  }
  preferredName = nameInput;
  document.getElementById('welcomeScreen').style.display = 'none';
  document.getElementById('chat').style.display = 'block';
  addMessage('bot', `Hi ${preferredName}! How can I assist you today?`);
  document.getElementById('userInput').focus();
});

document.getElementById('sendBtn').addEventListener('click', async () => {
  const inputField = document.getElementById('userInput');
  const message = inputField.value.trim();
  if (!message) {
    inputField.style.border = '2px solid red';
    setTimeout(() => inputField.style.border = '', 1000); // Reset border after 1 second
    return;
  }

  addMessage('user', message);
  inputField.value = '';

  document.getElementById('sendBtn').disabled = true;
  addMessage('bot', "Typing...");
  try {
    const res = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ preferredName, message })
    });

    const data = await res.json();
    document.querySelector('.bot:last-child').remove(); // Remove "Typing..." message
    if (data && data.reply) {
      addMessage('bot', data.reply);
    } else {
      addMessage('bot', "Sorry, I didn't understand that.");
    }
  } finally {
    document.getElementById('sendBtn').disabled = false;
  }
});

document.getElementById('userInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('sendBtn').click();
  }
});

function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addMessage(sender, text) {
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${sender}`;
  msgDiv.innerHTML = escapeHTML(text);
  document.getElementById('messages').appendChild(msgDiv);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

function saveChatHistory() {
  const messages = Array.from(document.getElementById('messages').children).map(msg => ({
    sender: msg.className.split(' ')[1],
    text: msg.textContent
  }));
  localStorage.setItem('chatHistory', JSON.stringify(messages));
}

function loadChatHistory() {
  const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  history.forEach(msg => addMessage(msg.sender, msg.text));
}

window.addEventListener('beforeunload', saveChatHistory);
window.addEventListener('load', loadChatHistory);
</script>

</body>
</html>
